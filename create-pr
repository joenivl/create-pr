#!/bin/bash

SCRIPT_PATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

source "${SCRIPT_PATH}/.env"

# Check for test parameter
TEST_MODE=false
if [[ "$1" == "--test" ]] || [[ "$1" == "-t" ]]; then
  TEST_MODE=true
fi

# Define some vars
favro_placeholder="https://favro.com/organization/..."
favro_url="https://favro.com/organization/$FAVRO_ORGANIZATION_ID/$FAVRO_SPRINT_BOARD?card=Zon-"
summary_placeholder="Beschrijf kort wat er in deze pull request aangetroffen wordt."
cardId=false

# Try to find ticket number from branch name first
original_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
current_branch=$(echo "$original_branch" | tr '[:lower:]' '[:upper:]')

ticket_regex="ZON-([0-9]+)"
if [[ $current_branch =~ $ticket_regex ]]; then
  cardId="Zon-${BASH_REMATCH[1]}"
  favro_url="$favro_url${BASH_REMATCH[1]}"
  
  # Extract branch name part after ZON-XXXX- and replace dashes with spaces
  # Remove everything up to and including ZON-XXXX- (case-insensitive)
  branch_name_part=$(echo "$original_branch" | sed -E "s/.*[Zz][Oo][Nn]-[0-9]+-?//" | tr '-' ' ')
  pr_title="$cardId: $branch_name_part"
else
  # Branch doesn't contain ticket number, try latest commit
  echo 'No ticket found in branch name, checking latest commit...'
  latest_commit=$(git log --pretty=format:"%B" -1 | tr '[:lower:]' '[:upper:]')

  if [[ $latest_commit =~ $ticket_regex ]]; then
    cardId="Zon-${BASH_REMATCH[1]}"
    favro_url="$favro_url${BASH_REMATCH[1]}"
    echo "Found ticket $cardId in latest commit"
  else
    echo 'No valid ticket number found in branch or latest commit'
    read -p "Please enter ticket number (format: ZON-1234): " user_input
    user_input=$(echo "$user_input" | tr '[:lower:]' '[:upper:]')

    if [[ $user_input =~ $ticket_regex ]]; then
      cardId="Zon-${BASH_REMATCH[1]}"
      favro_url="$favro_url${BASH_REMATCH[1]}"
      echo "Using ticket $cardId"
    else
      echo "Invalid ticket number format. Expected format: ZON-1234"
      exit
    fi
  fi
  
  # Extract branch name part after ZON-XXXX- and replace dashes with spaces
  # Remove everything up to and including ZON-XXXX- (case-insensitive)
  branch_name_part=$(echo "$original_branch" | sed -E "s/.*[Zz][Oo][Nn]-[0-9]+-?//" | tr '-' ' ')
  pr_title="$cardId: $branch_name_part"
fi

# Fetch card details or use git commit messages
if [ -n "$FAVRO_ORGANIZATION_ID" ] && [ -n "$FAVRO_API_USER" ] && [ -n "$FAVRO_API_TOKEN" ]; then
  response=$(curl -s GET "$FAVRO_API_URL/cards?cardSequentialId=$cardId" \
      -H "organizationId: $FAVRO_ORGANIZATION_ID" \
      -u "$FAVRO_API_USER":"$FAVRO_API_TOKEN")

  cardCommonId=$(echo $response | jq -r .entities[0].cardCommonId)

  description_raw=$(echo $response | jq -r .entities[0].detailedDescription)
  description=$(echo "$description_raw" | jq -Rsa .)
else
  description_raw=$(git log --pretty=format:"%s" origin/$GIT_BASE_BRANCH..HEAD)
  description=$(echo "$description_raw" | jq -Rsa .)
fi

# Fetch commit messages
git fetch $GIT_REMOTE_NAME

if [ -n "$OPEN_AI_API_URL" ] && [ -n "$OPEN_AI_API_TOKEN" ]; then
  # Get git diff changes
  git_changes_raw=$(git diff origin/$GIT_BASE_BRANCH..HEAD)
  
  # Combine description and git changes
  combined_content="Ticket beschrijving:\n$description_raw\n\nGit wijzigingen:\n$git_changes_raw"
  combined_content_escaped=$(echo -e "$combined_content" | jq -Rsa .)
  
  response=$(curl -s "$OPEN_AI_API_URL/chat/completions" \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer $OPEN_AI_API_TOKEN" \
    -d '{
      "model": "gpt-5-nano-2025-08-07",
      "response_format": { "type": "text" },
      "messages": [
        {
          "role": "system",
          "content": "Je bent een Nederlandstalig Software Engineer en je moet een ticket samenvatten in maximaal 500 karakters als text en in het Nederlands. De input bevat de ticket beschrijving en de git wijzigingen. Geef een korte, directe samenvatting in één zin over wat er is gedaan (bijvoorbeeld: Een command aangemaakt om de form_templates tabel te vullen van bestaande templates). Gebruik de git wijzigingen als backup als de ticket beschrijving niet duidelijk is maar ga uit van de ticket beschrijving. Geen structuur met Doel: of Reden:, geen opsomming van wijzigingen, alleen een (paar) simpele zin(nen). Patroon ZON-[0-9] graag negeren"
        },
        {
          "role": "user",
          "content": '"$combined_content_escaped"'
        }
      ]
    }')

  summary=$(echo $response | jq -r .choices[0].message.content | tr -d '"')
fi

# Pull request template
pull_request_template=$(cat ".github/PULL_REQUEST_TEMPLATE.md" 2>/dev/null);

if [ -z "$pull_request_template" ]; then
  pull_request_template=$(cat "$SCRIPT_PATH/.github/PULL_REQUEST_TEMPLATE.md");
fi

pull_request_template="${pull_request_template/$favro_placeholder/$favro_url}"

if [ -n "$summary" ]; then
  pull_request_template=$(echo "$pull_request_template" | sed "s~${summary_placeholder}~${summary}~Ig")
fi

# Test mode: display PR data without creating
if [ "$TEST_MODE" = true ]; then
  echo "=== TEST MODE - PR will NOT be created ==="
  echo ""
  echo "PR Title:"
  echo "$pr_title"
  echo ""
  echo "PR Body:"
  echo "$pull_request_template"
  echo ""
  exit 0
fi

# Create the pull request interactively
gh pr create -B $GIT_BASE_BRANCH --fill -b "$pull_request_template" -t "$pr_title"

# Get the PR URL from the most recent PR on this branch
pr_url=$(gh pr view --json url --jq .url 2>/dev/null)

if [ -n "$pr_url" ] && [ -n "$FAVRO_ORGANIZATION_ID" ] && [ -n "$FAVRO_API_USER" ] && [ -n "$FAVRO_API_TOKEN" ]; then
  response=$(curl -s POST "$FAVRO_API_URL/comments" \
      -d '{"comment": "'$pr_url'", "cardCommonId": "'"$cardCommonId"'"}' \
      -H "Content-Type: application/json" \
      -H "organizationId: $FAVRO_ORGANIZATION_ID" \
      -u "$FAVRO_API_USER":"$FAVRO_API_TOKEN")

    open -u "$pr_url"
fi

exit;