#!/bin/bash

SCRIPT_PATH="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 ; pwd -P )"

source "${SCRIPT_PATH}/.env"

# Check for test parameter and base branch option
TEST_MODE=false
BASE_BRANCH=""
READY_TO_REVIEW=false
MOVE_ONLY=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --test|-t)
      TEST_MODE=true
      shift
      ;;
    --base|-b)
      if [ -z "$2" ]; then
        echo "Error: --base requires a branch name"
        exit 1
      fi
      BASE_BRANCH="$2"
      shift 2
      ;;
    --ready|-r)
      READY_TO_REVIEW=true
      shift
      ;;
    --move-only|-m)
      MOVE_ONLY=true
      READY_TO_REVIEW=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: $0 [--test|-t] [--base|-b BRANCH] [--ready|-r] [--move-only|-m]"
      exit 1
      ;;
  esac
done

# Use BASE_BRANCH if set, otherwise fall back to GIT_BASE_BRANCH
TARGET_BRANCH="${BASE_BRANCH:-$GIT_BASE_BRANCH}"

# Define some vars
favro_placeholder="https://favro.com/organization/..."
favro_url="https://favro.com/organization/$FAVRO_ORGANIZATION_ID/$FAVRO_SPRINT_BOARD?card=Zon-"
summary_placeholder="Beschrijf kort wat er in deze pull request aangetroffen wordt."
cardId=false

# Try to find ticket number from branch name first
original_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
current_branch=$(echo "$original_branch" | tr '[:lower:]' '[:upper:]')

ticket_regex="ZON-([0-9]+)"
if [[ $current_branch =~ $ticket_regex ]]; then
  cardId="Zon-${BASH_REMATCH[1]}"
  favro_url="$favro_url${BASH_REMATCH[1]}"
  
  # Extract branch name part after ZON-XXXX- and replace dashes with spaces
  # Remove everything up to and including ZON-XXXX- (case-insensitive)
  branch_name_part=$(echo "$original_branch" | sed -E "s/.*[Zz][Oo][Nn]-[0-9]+-?//" | tr '-' ' ')
  pr_title="$cardId: $branch_name_part"
else
  # Branch doesn't contain ticket number, try latest commit
  echo 'No ticket found in branch name, checking latest commit...'
  latest_commit=$(git log --pretty=format:"%B" -1 | tr '[:lower:]' '[:upper:]')

  if [[ $latest_commit =~ $ticket_regex ]]; then
    cardId="Zon-${BASH_REMATCH[1]}"
    favro_url="$favro_url${BASH_REMATCH[1]}"
    echo "Found ticket $cardId in latest commit"
  else
    echo 'No valid ticket number found in branch or latest commit'
    read -p "Please enter ticket number (format: ZON-1234): " user_input
    user_input=$(echo "$user_input" | tr '[:lower:]' '[:upper:]')

    if [[ $user_input =~ $ticket_regex ]]; then
      cardId="Zon-${BASH_REMATCH[1]}"
      favro_url="$favro_url${BASH_REMATCH[1]}"
      echo "Using ticket $cardId"
    else
      echo "Invalid ticket number format. Expected format: ZON-1234"
      exit
    fi
  fi
  
  # Extract branch name part after ZON-XXXX- and replace dashes with spaces
  # Remove everything up to and including ZON-XXXX- (case-insensitive)
  branch_name_part=$(echo "$original_branch" | sed -E "s/.*[Zz][Oo][Nn]-[0-9]+-?//" | tr '-' ' ')
  pr_title="$cardId: $branch_name_part"
fi

# Fetch card details or use git commit messages
cardCommonId=""
cardIdForUpdate=""
if [ -n "$FAVRO_ORGANIZATION_ID" ] && [ -n "$FAVRO_API_USER" ] && [ -n "$FAVRO_API_TOKEN" ]; then
  # Build query string with widgetCommonId if available
  query_string="cardSequentialId=$cardId"
  if [ -n "$FAVRO_SPRINT_BOARD_WIDGET_ID" ]; then
    query_string="${query_string}&widgetCommonId=$FAVRO_SPRINT_BOARD_WIDGET_ID"
  fi
  
  response=$(curl -s GET "$FAVRO_API_URL/cards?${query_string}" \
      -H "organizationId: $FAVRO_ORGANIZATION_ID" \
      -u "$FAVRO_API_USER":"$FAVRO_API_TOKEN")

  cardCommonId=$(echo $response | jq -r .entities[0].cardCommonId)
  cardIdForUpdate=$(echo $response | jq -r .entities[0].cardId)

  description_raw=$(echo $response | jq -r .entities[0].detailedDescription)
  description=$(echo "$description_raw" | jq -Rsa .)
else
  description_raw=$(git log --pretty=format:"%s" origin/$TARGET_BRANCH..HEAD)
  description=$(echo "$description_raw" | jq -Rsa .)
fi

# Skip PR creation if move-only mode is enabled
if [ "$MOVE_ONLY" = false ]; then
  # Fetch commit messages
  git fetch $GIT_REMOTE_NAME

  if [ -n "$OPEN_AI_API_URL" ] && [ -n "$OPEN_AI_API_TOKEN" ]; then
    # Get git diff changes
    git_changes_raw=$(git diff origin/$TARGET_BRANCH..HEAD)
    
    # Combine description and git changes
    combined_content="Ticket beschrijving:\n$description_raw\n\nGit wijzigingen:\n$git_changes_raw"
    combined_content_escaped=$(echo -e "$combined_content" | jq -Rsa .)
    
    response=$(curl -s "$OPEN_AI_API_URL/chat/completions" \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $OPEN_AI_API_TOKEN" \
      -d '{
        "model": "gpt-5-nano-2025-08-07",
        "response_format": { "type": "text" },
        "messages": [
          {
            "role": "system",
            "content": "Je bent een Nederlandstalig Software Engineer en je moet een ticket samenvatten in maximaal 500 karakters als text en in het Nederlands. De input bevat de ticket beschrijving en de git wijzigingen. Geef een korte, directe samenvatting in één zin over wat er is gedaan (bijvoorbeeld: Een command aangemaakt om de form_templates tabel te vullen van bestaande templates). Gebruik de git wijzigingen als backup als de ticket beschrijving niet duidelijk is maar ga uit van de ticket beschrijving. Geen structuur met Doel: of Reden:, geen opsomming van wijzigingen, alleen een (paar) simpele zin(nen). Ga ervan uit de lezer al kennis heeft van het bestaande systeem. Patroon ZON-[0-9] graag negeren"
          },
          {
            "role": "user",
            "content": '"$combined_content_escaped"'
          }
        ]
      }')

    summary=$(echo $response | jq -r .choices[0].message.content | tr -d '"')
  fi

  # Pull request template
  pull_request_template=$(cat ".github/PULL_REQUEST_TEMPLATE.md" 2>/dev/null);

  if [ -z "$pull_request_template" ]; then
    pull_request_template=$(cat "$SCRIPT_PATH/.github/PULL_REQUEST_TEMPLATE.md");
  fi

  pull_request_template="${pull_request_template/$favro_placeholder/$favro_url}"

  if [ -n "$summary" ]; then
    pull_request_template=$(echo "$pull_request_template" | sed "s~${summary_placeholder}~${summary}~Ig")
  fi

  # Test mode: display PR data without creating
  if [ "$TEST_MODE" = true ]; then
    echo "=== TEST MODE - PR will NOT be created ==="
    echo "Target Branch:"
    echo "$TARGET_BRANCH"
    echo ""
    if [ "$READY_TO_REVIEW" = true ]; then
      echo "Ready to Review: Enabled"
      if [ -n "$cardIdForUpdate" ]; then
        echo "Card ID for update: $cardIdForUpdate"
      fi
      echo ""
    fi
    if [ "$MOVE_ONLY" = true ]; then
      echo "Move Only Mode: Enabled (PR creation will be skipped)"
      echo ""
    fi
    echo "PR Title:"
    echo "$pr_title"
    echo ""
    echo "PR Body:"
    echo "$pull_request_template"
    echo ""
    exit 0
  fi

  # Create the pull request interactively
  gh pr create -B $TARGET_BRANCH --fill -b "$pull_request_template" -t "$pr_title"

  # Get the PR URL from the most recent PR on this branch
  pr_url=$(gh pr view --json url --jq .url 2>/dev/null)

  if [ -n "$pr_url" ] && [ -n "$FAVRO_ORGANIZATION_ID" ] && [ -n "$FAVRO_API_USER" ] && [ -n "$FAVRO_API_TOKEN" ]; then
    response=$(curl -s POST "$FAVRO_API_URL/comments" \
        -d '{"comment": "'$pr_url'", "cardCommonId": "'"$cardCommonId"'"}' \
        -H "Content-Type: application/json" \
        -H "organizationId: $FAVRO_ORGANIZATION_ID" \
        -u "$FAVRO_API_USER":"$FAVRO_API_TOKEN")

      open -u "$pr_url"
  fi
else
  # Move-only mode: skip PR creation
  if [ "$TEST_MODE" = true ]; then
    echo "=== TEST MODE - Move Only Mode ==="
    echo "PR creation will be skipped"
    echo ""
    if [ -n "$cardIdForUpdate" ]; then
      echo "Card ID for update: $cardIdForUpdate"
    else
      echo "Warning: Card ID not found"
    fi
    echo ""
    exit 0
  fi
  echo "Move-only mode: Skipping PR creation, moving card to ready to review..."
fi

# Update card to ready to review column if flag is set
if [ "$READY_TO_REVIEW" = true ] && [ -n "$cardIdForUpdate" ] && [ -n "$FAVRO_READY_TO_REVIEW_COLUMN" ] && [ -n "$FAVRO_ORGANIZATION_ID" ] && [ -n "$FAVRO_API_USER" ] && [ -n "$FAVRO_API_TOKEN" ] && [ -n "$FAVRO_SPRINT_BOARD_WIDGET_ID" ]; then
  # Build update payload using jq for proper JSON formatting
  update_payload=$(jq -n \
    --arg columnId "$FAVRO_READY_TO_REVIEW_COLUMN" \
    --arg widgetCommonId "$FAVRO_SPRINT_BOARD_WIDGET_ID" \
    '{columnId: $columnId, widgetCommonId: $widgetCommonId}')
  
  response=$(curl -s -X PUT "$FAVRO_API_URL/cards/$cardIdForUpdate" \
      -d "$update_payload" \
      -H "Content-Type: application/json" \
      -H "organizationId: $FAVRO_ORGANIZATION_ID" \
      -u "$FAVRO_API_USER":"$FAVRO_API_TOKEN")
  
  # Check if the update was successful
  updated_card_id=$(echo $response | jq -r .cardId 2>/dev/null)
  if [ -n "$updated_card_id" ] && [ "$updated_card_id" != "null" ]; then
    echo "Card moved to ready to review column"
  else
    echo "Failed to move card to ready to review column"
    echo "Response: $response"
  fi
fi

exit;